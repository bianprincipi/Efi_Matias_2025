{% extends "base.html" %}
{% load static %}

{% block title %}Detalle y Reserva - {{ flight.flight_number }}{% endblock %}

{% block content %}

<style>
  .seat-map { background: #f8f8f8; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
  .seat-row { display: flex; justify-content: center; margin-bottom: 10px; align-items: center; gap: 6px; }
  .seat { width: 35px; height: 35px; line-height: 35px; text-align: center; border-radius: 5px; font-size: 0.8em; cursor: pointer; border: 1px solid #ccc; transition: all 0.2s; position: relative; }
  .seat.reserved { background-color: #dc3545; color: white; cursor: not-allowed; }
  .seat.available { background-color: #28a745; color: white; }
  .seat input[type="radio"] { opacity: 0; position: absolute; inset: 0; width: 100%; height: 100%; cursor: pointer; }
  .seat input[type="radio"]:checked + label { background-color: #007bff; color: white; border-color: #007bff; transform: scale(1.1); }
  .seat label { display: block; width: 100%; height: 100%; line-height: 35px; cursor: inherit; border-radius: 5px; }
  .aisle { min-width: 30px; text-align: center; color: #999; font-weight: 600; }
</style>

<div class="container mt-5 pt-5">
  <!-- Meta del avión para JS -->
  <div id="aircraft-meta" data-aircraft-id="{{ aircraft.id }}"></div>

  <div class="row">
    <!-- Columna izquierda: info de vuelo + formulario -->
    <div class="col-md-5">
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h2 class="card-title text-primary">{{ flight.origin }} ➡️ {{ flight.destination }}</h2>
          <p class="text-muted">Vuelo {{ flight.flight_number }}</p>
          <hr>
          <p><strong>Salida:</strong> {{ flight.departure_time|date:"d/m/Y H:i" }}</p>
          <p><strong>Llegada:</strong> {{ flight.arrival_time|date:"d/m/Y H:i" }}</p>
          <p><strong>Aeronave:</strong> {{ aircraft.model_name|default:aircraft.model }}</p>
          <p><strong>Precio:</strong> <span class="text-success h4">${{ flight.price|floatformat:2 }}</span></p>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-body">
          <h4 class="card-title">Confirmar Reserva</h4>

          <!-- IMPORTANTE: id="reservation-form" para el JS -->
          <form id="reservation-form" method="POST" action="{% url 'flight_detail' flight_id=flight.id %}">
            {% csrf_token %}

            <!-- Flight ID para JS -->
            <input type="hidden" name="flight" value="{{ flight.id }}">

            <!-- Seat hidden: se completa al hacer clic en el seat map -->
            <input
              type="hidden"
              name="{{ form.seat.name }}"
              id="id_seat"
              value="{{ form.seat.value|default:'' }}"
            >

            <div class="mb-3">
              <label for="{{ form.passenger.id_for_label }}" class="form-label">Selecciona Pasajero</label>
              {{ form.passenger }}
              {% if form.passenger.errors %}<div class="text-danger small">{{ form.passenger.errors }}</div>{% endif %}
            </div>

            <button type="submit" class="search-button w-100 mt-3">
              Completar Reserva
            </button>

            {% if form.seat.errors %}
              <div class="alert alert-danger mt-2">Asiento: {{ form.seat.errors }}</div>
            {% endif %}
          </form>

          <!-- Botón para refrescar asientos disponibles vía API -->
          <button id="refresh-seats" type="button" class="btn btn-outline-primary mt-3 w-100">Actualizar asientos</button>
        </div>
      </div>
    </div>

    <!-- Columna derecha: seat map -->
    <div class="col-md-7">
      <h3>Selecciona tu Asiento</h3>

      <div class="seat-map text-center">
        <p class="text-secondary">Selecciona un asiento disponible (verde)</p>

        {% for row_number, seats in seats_by_row.items %}
          <div class="seat-row">
            <span class="aisle">{{ row_number }}</span>

            {% for seat_data in seats %}
              {% with seat=seat_data.object %}
                <div
                  class="seat {% if seat_data.is_reserved %}reserved{% else %}available{% endif %}"
                  title="Asiento {{ seat.seat_number }} - {% if seat_data.is_reserved %}Reservado{% else %}Disponible{% endif %}"  <!-- CAMBIO: usar seat_number -->
                >
                  {% if not seat_data.is_reserved %}
                    <input
                      type="radio"
                      name="seat_selector"
                      value="{{ seat.id }}"
                      id="seat_{{ seat.id }}"
                      {% comment %} CAMBIO: comparar como string sin filtros custom {% endcomment %}
                      {% if form.seat.value|stringformat:"s" == seat.id|stringformat:"s" %}checked{% endif %}  <!-- CAMBIO -->
                      onclick="document.getElementById('id_seat').value = this.value;"
                    >
                    <label for="seat_{{ seat.id }}">{{ seat.seat_number }}</label> <!-- CAMBIO: mostrar seat_number -->
                  {% else %}
                    <label>{{ seat.seat_number }}</label> <!-- CAMBIO: mostrar seat_number -->
                  {% endif %}
                </div>
              {% endwith %}
            {% endfor %}

            <span class="aisle">{{ row_number }}</span>
          </div>
        {% endfor %}

        <div class="legend mt-3">
          <span class="badge bg-success">Disponible</span>
          <span class="badge bg-danger">Reservado</span>
          <span class="badge bg-primary">Seleccionado</span>
        </div>
      </div>
    </div>
  </div>

  <a href="{% url 'search_flights' %}" class="btn btn-secondary mt-4">⬅️ Volver a Resultados</a>
  <div id="api-message" class="mt-3"></div>
</div>

{% endblock content %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  // --- Utilidades y refs ---
  const accessToken   = localStorage.getItem('access_token');
  const apiMessage    = document.getElementById('api-message');
  const formReserva   = document.getElementById('reservation-form');
  const aircraftMeta  = document.getElementById('aircraft-meta');
  const aircraftId    = aircraftMeta ? aircraftMeta.dataset.aircraftId : null;
  const flightId      = document.querySelector('input[name="flight"]')?.value;

  function authHeaders() {
    return accessToken ? { 'Authorization': `Bearer ${accessToken}` } : {};
  }
  function toast(msg, type='info') {
    const colors = { info:'#2b6cb0', ok:'#2f855a', warn:'#b7791f', err:'#c53030' };
    apiMessage.innerHTML = `<div style="padding:10px;border-radius:6px;color:#fff;background:${colors[type]||colors.info};margin-top:10px">${msg}</div>`;
  }

  if (!formReserva) { console.error("No se encontró el formulario de reserva."); return; }

  // --- Envío de reserva: POST a /flights/api/reservas/ ---
  formReserva.addEventListener('submit', async (event) => {
    event.preventDefault();
    apiMessage.innerHTML = '';

    const seatIdInput  = document.getElementById('id_seat');
    const passengerSel = document.getElementById('id_passenger');
    const submitButton = formReserva.querySelector('button[type="submit"]');

    if (!seatIdInput?.value) { toast('Por favor, selecciona un asiento.', 'warn'); return; }
    if (!passengerSel?.value) { toast('Por favor, selecciona un pasajero.', 'warn'); return; }
    if (!flightId) { toast('Falta el ID de vuelo en el formulario.', 'err'); return; }

    if (!accessToken) {
      alert("Debes iniciar sesión para realizar una reserva.");
      window.location.href = "{% url 'flights:login' %}";
      return;
    }

    // -> Lo que espera el serializer (passenger_id, flight_id, seat_id)
    const payload = {
      passenger_id: passengerSel.value,
      flight_id:    flightId,
      seat_id:      seatIdInput.value
    };

    submitButton.disabled = true;

    try {
      const resp = await fetch('/flights/api/reservas/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...authHeaders() },
        body: JSON.stringify(payload)
      });

      const data = await resp.json();

      if (!resp.ok) {
        const detail = data?.error || data?.message || (data?.data && JSON.stringify(data.data)) || 'No se pudo crear la reserva.';
        throw new Error(typeof detail === 'string' ? detail : JSON.stringify(detail));
      }

      const code = data?.data?.reservation_code || 'N/A';
      toast(`¡Reserva creada con éxito! Código: ${code}`, 'ok');
      // Si querés, redirigí al inicio o a una página de detalle:
      // window.location.href = `/flights/reservation/${data.data.id}/`;
    } catch (err) {
      toast(`Error al crear la reserva: ${err.message}`, 'err');
      submitButton.disabled = false;
    }
  });

  // --- Refrescar disponibilidad desde la API ---
  async function refrescarDisponibilidad() {
    if (!aircraftId || !flightId) return;
    try {
      const url  = `/flights/api/aviones/${aircraftId}/disponibilidad?vuelo_id=${flightId}`;
      const resp = await fetch(url);
      if (!resp.ok) throw new Error('No se pudo obtener disponibilidad');
      const data = await resp.json(); // { vuelo_id, disponibles_count, asientos: [...] }
      toast(`Asientos disponibles: ${data.disponibles_count}`, 'info');

      // (Opcional) Acá podés actualizar visualmente el mapa según data.asientos.
      // Por simplicidad, lo dejamos como feedback y selección manual.
    } catch (e) {
      toast(`No se pudo actualizar la disponibilidad: ${e.message}`, 'err');
    }
  }
  document.getElementById('refresh-seats')?.addEventListener('click', refrescarDisponibilidad);
});
</script>
{% endblock %}
