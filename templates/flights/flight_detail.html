{% extends "flights/base.html" %}

{% block content %}
    <h1 class="mb-4">Vuelo {{ flight.flight_number }}: {{ flight.origin }} a {{ flight.destination }}</h1>

    <div class="row">
        <div class="col-lg-7">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">Información del Vuelo</div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item"><strong>Avión:</strong> {{ flight.aircraft.model_name }} ({{ flight.aircraft.registration_number }})</li>
                    <li class="list-group-item"><strong>Salida:</strong> {{ flight.departure_time|date:"d M Y H:i" }}</li>
                    <li class="list-group-item"><strong>Llegada:</strong> {{ flight.arrival_time|date:"d M Y H:i" }}</li>
                    <li class="list-group-item">
                        <strong>Asientos:</strong> {{ available_seats_count }} disponibles / {{ flight.aircraft.capacity }} total
                        {% if available_seats_count == 0 %}
                            <span class="badge bg-danger ms-2">Vuelo Lleno</span>
                        {% endif %}
                    </li>
                </ul>
            </div>
        </div>

        <div class="col-lg-5">
            <div class="card mb-4 shadow-lg">
                <div class="card-header bg-success text-white">Reservar Asiento</div>
                <div class="card-body">
                    {% if available_seats_count > 0 %}
                        <form method="post" action="{% url 'flight_detail' flight.id %}">
                            {% csrf_token %}
                            
                            {% if reservation_form.non_field_errors %}
                                <div class="alert alert-danger">
                                    {{ reservation_form.non_field_errors }}
                                </div>
                            {% endif %}
                            
                            {{ reservation_form.flight_id }}

                            <div class="mb-3">
                                <label class="form-label" for="{{ reservation_form.passenger.id_for_label }}">Pasajero</label>
                                {{ reservation_form.passenger }}
                                {% for error in reservation_form.passenger.errors %}
                                    <small class="text-danger">{{ error }}</small>
                                {% endfor %}
                            </div>

                            <div class="mb-3">
                                <label class="form-label" for="{{ reservation_form.seat.id_for_label }}">Asiento Disponible</label>
                                {{ reservation_form.seat }}
                                {% for error in reservation_form.seat.errors %}
                                    <small class="text-danger">{{ error }}</small>
                                {% endfor %}
                            </div>

                            <button type="submit" class="btn btn-success w-100 mt-3">Confirmar Reserva</button>
                        </form>
                    {% else %}
                        <p class="text-danger">Lo sentimos, este vuelo está completo. No hay asientos disponibles para reservar.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="mt-4">
        <h3>Asientos disponibles</h3>
        {% if available_seats %}
            {% for seat in available_seats %}
                <span class="badge bg-success me-1 my-1">{{ seat.seat_number }} ({{ seat.get_seat_class_display }})</span>
            {% endfor %}
        {% else %}
            <p>No hay asientos disponibles.</p>
        {% endif %}
    </div>

    <div class="mt-4">
    <h3>Mapa de Asientos ({{ available_seats_count }} disponibles)</h3>
    <div class="d-flex flex-wrap">
        {% for seat in all_seats %}
            {% if seat.id in reserved_seat_ids %}
                <span class="badge bg-danger me-1 my-1 p-2" title="Ocupado">
                    {{ seat.seat_number }}
                </span>
            {% else %}
                <span class="badge bg-success me-1 my-1 p-2">
                    {{ seat.seat_number }}
                </span>
            {% endif %}
        {% endfor %}
    </div>
</div>

{% endblock %}