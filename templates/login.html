{% extends "base.html" %} 

{% block title %}Iniciar Sesión - Aerolínea{% endblock %}

{% block content %}
<div style="max-width: 400px; margin: 50px auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px;">
    <h2 style="text-align: center; margin-bottom: 20px;">Acceso al Sistema</h2>
    
    <div id="login_form_container">
        <label for="login_username">Usuario:</label>
        <input type="text" id="login_username" placeholder="Nombre de usuario" required style="width: 100%; padding: 10px; margin-bottom: 15px; box-sizing: border-box;">
        
        <label for="login_password">Contraseña:</label>
        <input type="password" id="login_password" placeholder="Contraseña" required style="width: 100%; padding: 10px; margin-bottom: 20px; box-sizing: border-box;">
        
        <button id="login_button" style="width: 100%; padding: 10px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">Ingresar</button> 
        
        <p id="login_message" style="color: red; text-align: center; margin-top: 15px;"></p>
    </div>

    <hr style="margin: 20px 0;">
    <div style="text-align: center;">
        <p style="margin-bottom: 10px;">¿Aún no tienes cuenta?</p>
        <a id="register_link" href="{% url 'flights:registrarse' %}" style="display: block; width: 100%; padding: 10px; background-color: #007bff; color: white; border: none; border-radius: 5px; text-decoration: none; cursor: pointer;">
            Regístrate Aquí
        </a>
    </div>
    
</div>
{% endblock %}

{% block extra_js %}
<script>
// Función para obtener el valor del parámetro 'next' de la URL
function getNextUrl() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('next');
}

document.addEventListener('DOMContentLoaded', function() {
    const loginButton = document.getElementById('login_button');
    const nextUrl = getNextUrl(); // Obtenemos la URL de destino deseada

    // Si existe una URL de destino ('next'), la pasamos también al enlace de registro
    if (nextUrl) {
        const registerLink = document.getElementById('register_link');
        registerLink.href = `/registrarse/?next=${encodeURIComponent(nextUrl)}`;
    }

    if (loginButton) {
        loginButton.addEventListener('click', async function() {
            // ... (código para obtener credenciales y mostrar mensaje es el mismo) ...
            const username = document.getElementById('login_username').value;
            const password = document.getElementById('login_password').value;
            const messageDisplay = document.getElementById('login_message');
            
            messageDisplay.textContent = 'Procesando...';
            messageDisplay.style.color = 'black'; 

            if (!username || !password) {
                messageDisplay.style.color = 'red';
                messageDisplay.textContent = 'Por favor, ingrese usuario y contraseña.';
                return;
            }

            // 1. OBTENER TOKEN (Llamada al endpoint JWT)
            const API_URL = 'http://127.0.0.1:8000/api/token/';

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // Éxito: Guardar los tokens
                    localStorage.setItem('access_token', data.access);
                    localStorage.setItem('refresh_token', data.refresh);
                    
                    messageDisplay.textContent = 'Verificando perfil y permisos...'; 

                    // 2. OBTENER PERFIL
                    const profileResponse = await fetch('http://127.00.1:8000/flights/api/profile/', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${data.access}` 
                        }
                    });

                    if (profileResponse.ok) {
                        const profileData = await profileResponse.json();
                        
                        localStorage.setItem('is_admin', profileData.is_staff); 
                        
                        messageDisplay.style.color = 'green';
                        
                        // 3. LÓGICA DE REDIRECCIÓN FINAL MODIFICADA
                        
                        // PRIORIDAD: 1. URL 'next', 2. Dashboard (Admin), 3. Inicio (Pasajero)
                        
                        let finalRedirectUrl = '/flights/'; // Por defecto
                        
                        // A. Si existe una URL 'next' (vienes de una reserva), ¡ve allí!
                        if (nextUrl) {
                            finalRedirectUrl = nextUrl;
                            messageDisplay.textContent = '¡Login exitoso! Redirigiendo a la reserva...';
                        }
                        // B. Si no hay 'next' y es Admin, ve al Dashboard
                        else if (profileData.is_staff === true) {
                            finalRedirectUrl = '/flights/dashboard/';
                            messageDisplay.textContent = '¡Bienvenido Administrador! Redirigiendo a Dashboard...';
                        }
                        // C. Si no hay 'next' y es Pasajero, ve al inicio
                        else {
                            messageDisplay.textContent = '¡Bienvenido Pasajero! Redirigiendo a inicio...';
                        }
                        
                        // Ejecutar la redirección
                        window.location.href = finalRedirectUrl; 

                    } else {
                        // Fallo al obtener perfil (pero el token es válido)
                        messageDisplay.style.color = 'orange';
                        messageDisplay.textContent = 'Login exitoso, pero no se pudo obtener el perfil. Redirigiendo a inicio...';
                        window.location.href = '/flights/';
                    }


                } else {
                    // Fallo de Login (Ej: 401 Unauthorized)
                    let errorMessage = 'Error de credenciales. No active account found.';
                    if (data.detail) {
                        errorMessage = data.detail; 
                    }
                    messageDisplay.style.color = 'red';
                    messageDisplay.textContent = errorMessage;
                }

            } catch (error) {
                // Fallo de conexión o red
                console.error('Error de conexión:', error);
                messageDisplay.style.color = 'red';
                messageDisplay.textContent = 'No se pudo conectar al servidor. Verifique que Django esté corriendo.';
            }
        });
    }
});
</script>
{% endblock %}